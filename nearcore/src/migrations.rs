#[cfg(feature = "protocol_feature_flat_state")]
use crate::NightshadeRuntime;
use borsh::BorshSerialize;
use near_chain::{ChainStore, ChainStoreAccess, RuntimeAdapter};
use near_epoch_manager::EpochManagerAdapter;
use near_primitives::receipt::ReceiptResult;
use near_primitives::runtime::migration_data::MigrationData;
use near_primitives::state::ValueRef;
use near_primitives::state_record::StateRecord;
use near_primitives::types::Gas;
use near_primitives::utils::index_to_bytes;
use near_store::metadata::{DbVersion, DB_VERSION};
use near_store::migrations::BatchedStoreUpdate;
use near_store::{DBCol, NibbleSlice, NodeStorage, Store, Temperature, Trie, TrieIterator};
use std::sync::Arc;
#[cfg(feature = "protocol_feature_flat_state")]
use tracing::{debug, info};

/// Fix an issue with block ordinal (#5761)
// This migration takes at least 3 hours to complete on mainnet
pub fn migrate_30_to_31(
    storage: &NodeStorage,
    near_config: &crate::NearConfig,
) -> anyhow::Result<()> {
    let store = storage.get_store(Temperature::Hot);
    if near_config.client_config.archive && &near_config.genesis.config.chain_id == "mainnet" {
        do_migrate_30_to_31(&store, &near_config.genesis.config)?;
    }
    Ok(())
}

/// Migrates the database from version 30 to 31.
///
/// Recomputes block ordinal due to a bug fixed in #5761.
pub fn do_migrate_30_to_31(
    store: &near_store::Store,
    genesis_config: &near_chain_configs::GenesisConfig,
) -> anyhow::Result<()> {
    let genesis_height = genesis_config.genesis_height;
    let chain_store = ChainStore::new(store.clone(), genesis_height, false);
    let head = chain_store.head()?;
    let mut store_update = BatchedStoreUpdate::new(&store, 10_000_000);
    let mut count = 0;
    // we manually checked mainnet archival data and the first block where the discrepancy happened is `47443088`.
    for height in 47443088..=head.height {
        if let Ok(block_hash) = chain_store.get_block_hash_by_height(height) {
            let block_ordinal = chain_store.get_block_merkle_tree(&block_hash)?.size();
            let block_hash_from_block_ordinal =
                chain_store.get_block_hash_from_ordinal(block_ordinal)?;
            if block_hash_from_block_ordinal != block_hash {
                println!(
                    "Inconsistency in block ordinal to block hash mapping found at block height {}",
                    height
                );
                count += 1;
                store_update
                    .set_ser(DBCol::BlockOrdinal, &index_to_bytes(block_ordinal), &block_hash)
                    .expect("BorshSerialize should not fail");
            }
        }
    }
    println!("total inconsistency count: {}", count);
    store_update.finish()?;
    Ok(())
}

/// Migrates database from version 34 to 35.
///
/// It is expected to run against a node without flat storage and should fill the flat storage
/// columns with state data related to last final head. In other words, previously used binary
/// should be built without `protocol_feature_flat_state` feature and new binary should include it.
/// Don't use in production, currently used for testing and estimation purposes.
#[cfg(feature = "protocol_feature_flat_state")]
pub fn migrate_34_to_35(
    storage: &NodeStorage,
    near_config: &crate::NearConfig,
) -> anyhow::Result<()> {
    let store = storage.get_store(Temperature::Hot);
    // just needed for NightshadeRuntime initialization and is used only for trying to retrieve state dump which is
    // not present. we should consider making this parameter optional or pass homedir to migrator
    let tmpdir = tempfile::Builder::new().prefix("storage").tempdir().unwrap();
    let runtime = NightshadeRuntime::from_config(tmpdir.path(), store.clone(), &near_config);
    do_migrate_34_to_35(runtime, &near_config.genesis.config)?;
    Ok(())
}

#[cfg(feature = "protocol_feature_flat_state")]
pub fn do_migrate_34_to_35(
    runtime: NightshadeRuntime,
    genesis_config: &near_chain_configs::GenesisConfig,
) -> anyhow::Result<()> {
    let store = runtime.store();
    let mut chain_store = ChainStore::new(store.clone(), genesis_config.genesis_height, false);
    let final_head = chain_store.final_head()?;
    let block_hash = final_head.last_block_hash;
    let epoch_id = runtime.get_epoch_id(&block_hash)?;
    let num_shards = runtime.num_shards(&epoch_id)?;
    let mut store_update = BatchedStoreUpdate::new(&store, 1_000);
    info!(target: "chain", "Writing flat state heads");
    for shard_id in 0..num_shards {
        store_update
            .set_ser(crate::DBCol::FlatStateMisc, &shard_id.try_to_vec().unwrap(), &block_hash)
            .expect("Error writing flat head from storage");
    }
    store_update.finish()?;

    // DEBUG SPECIFIC KEY
    let x = String::from("01302e636c69656e742e726f707374656e2e746573746303462356566326436376137396563333664326a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65766356365306637623831313735386361333067656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e612e73617279696f5f616e746f6e792e746573746e6337646438373830363261363965323463376a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e6261333035386664373363333530373434323967656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e6734653362383762313433386366353631613637363964353663346165656130386562613263666175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746563393732353163643166363330633434346462616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e666353662363664356538336361393932303066356232303033623562623964363237323038656175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465737c692e746573746e6535363165643339636638326266366236323931633066663061643666653137326261306337626175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657f636617469682e746573746e6526366326138623134343831386163323066363931333664343461323363353131313031323830386338323864643166636431646435623466633766875622e746573746e65742d636c69656e742e746573746e65e746573746e68616e746d616e2e746573746e676c696d7065732e746573746e6a61636b74657374312e746573746e657b616e656b692e746573746e6561726465762e746573746e726f68616e2e746573746e6365616a2e746573746e65746170726f6f742e74657312d7761676d6565742e746573746e657e62616361727261742e746573746e36c6561725f73746174652e74657374646c6d696e742e746573746e696e66692e746573746e6d31372e746573746e65792e746573746e66742d636f6e74726163742d69642d6d656476692d312e746573746e706f6368692e74657373130322d6465762d656c656374726f6e2d636f6e74726163742e75747361766a6e2e746573746e61312e666163746f72792e6772616e642e74657374231323132332e746573746e65732e666163746f72792e6772616e63132333435362e746573746e657372e7442e666163746f72792e6772616e642e746573746e63531323334353637382e746573746e6576373635343332312e7468382e746573746e75746d6b312e6d6f6f7061795f6465762e746573746e63676864676e2e6d6f6f7061795f6465762e746573746e6635343434303634363837302d3239343735382e616e6469736865682e746573746966363461353639613833643637353066316a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e673032313134322e746573746e637672346e2e6d6f6f7061795f6465762e746573746e68633666373466656536623164613037616366616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e746573746ef6b656e6c61756e636865722e746573746e656e69737761702e746573746e6577364742e746573746e93664333663396666393835373761376531646661756365742e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65757364742e746573746e61696b646b752e6d6f6f7061795f6465762e746573746e623639336464346137373461323066303930636661756365742e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65757364742e746573746e6577373463663366663364646538343431383433326430666631356135363661623863323366656a756d705f746f6b656e2e746573746e664633561626266323532383462666262613731393464656265633835616531386163383164396175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573393330333139613137383932396536333131616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e6686573732e746573746e657c692e746573746e646265316665306339393635613631333963376a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65757364742e746573746e65733465636233636464623737386265666463617361632e746573746e6575726f72615f746f6b656e2e746573746e63617274656c2e746573746e65746f6e732e746573746e65766c782e746573746e657766662e746573746e65786170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e65796e6b2e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a2e7465737e656b6f2e746573746e65770682e746573746e65663612e746573746e65774312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374672746e2e746573746e6574752e746573746e6f63746f7075735f746f6b656e2e746573746e65796e2e746573746e70617261732e746573746e65756d2e746573746e6578742e746573746e6536b79776172645f746f6b656e2e746573746e65756e692e746573746e6577364745f746f6b656e2e746573746e53531636364613933353439663030316132356175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573746e65757364745f746f6b656e2e746573746e6634343132653565353130333962653762336231653665356462306365336265326332323634396175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657364356931392e6d6f6f7061795f6465762e74657374622d7761676d6565742e746573746e65e6173686c65792d637265617465312e746573746e2616361727261742e746573746e36c6561725f73746174652e74657374646c6d696e742e746573746e696e66692e746573746e6d31392e746573746e65696c6f7332312e7465733032342d6465762d656c656374726f6e2d636f6e74726163742e75747361766a6e2e746573746135396236353334643135316366653832323238393962326531346562346566383732333734376175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657266636330633539323033386561626665313564326238616134613962353537623661366137376175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657432353961366534313161326466303262636439626338633863376336353332383330386535356175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465776164623235303030386434383236323932656175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573746e65757364745f746f6b656e2e746573746e657662656631313539623761666664633130396a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e656b6f2e746573746e6576745f7374616b696e672e746573746e757364742e746573746e69626434626137356234303763303266613163386631666331363039383433646638376230623932393130373234316461643465383232666463613130633365666539366661656166383334626436306a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65757364742e746573746e656c692e74657374632d7761676d6d65742e746573746e657e62616361727261742e746573746e646c6d696e742e746573743162326135376432383531666666663738343936643132646134326530663233613231363762346175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657338663965663433623962666165613364393736333865313036623938326564633737646139316175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465743366383131383232636637656265653431326661756365742e746573746e6577656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65757364742e746573746e65643136623334343939626664306634613334616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e658623635356335663137313738373066383767656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65352e746573746e65793230623536303766316133383437383231666c7578746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e656b6f2e746573746e6576745f7374616b696e672e746573746e757364742e746573746e6632623662663064353963653635363965643667656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e6576362d6465762d656c656374726f6e2d636f6e74726163742e75747361766a6e2e746573746e658393236386139343532386231372e746573746e63686573732e746573746ec692e746573746e656530636238663630343432333364323339376661756365742e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65746f6b656e6c61756e636865722e746573746e65757364742e746573746e6631343864363066616635636437613630316634346164346138653566386533363030343665346175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657c6c6f626f2e746573746e6d703872332e746573746e67269636b2e746573746e637761702e74657374642e646c6d696e742e7465737430366539613133633564623138623630333139616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e232332e746573746e633565383339363631373734303436373766306175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573746e65757364745f746f6b656e2e746573746e6464653731363133303839666535343635643939383065623161323663623030626239633062646175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746576336334663634303463336563366562323364616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e93363393139346464613566383164663338636661756365742e746573746e6577656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6561726d6565726b61746b696e672e746573746e6576745f7374616b696e672e746573746e706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865756e6465616461726d792e746573746e65757364742e746573746e6561383334326137613362376133653430303634333235323762623866626130343039343233616175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c6f636b65645f746f6b656e2e746573746e657e6674312e746573746e657f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74656232393133306639343534396330313437303267656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e656533353163313238326637323564613166366175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573746e65757364745f746f6b656e2e746573746e633230383531366464646163643138633062386a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e65623764653566636663633563393530363864616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e43465343864623936616538313663356231646175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573746e65757364745f746f6b656e2e74657374652e646c6d696e742e7465737430383530613866353035316333646566623933656c63616663617274656c67656e312e746573746e657661756365742e746573746e6577656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e6a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6561726d6565726b61746b696e672e746573746e65774696e6b6572756e696f6e2e7465737467068696c696d2e746573746e656745f7374616b696e672e746573746e706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737457364742e746573746e6566333130636531303932323966303032623561313765623634323536353133643266353664666175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657133343962363933326364643766666362666430616239666262633538343366386365303266376175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465737733353836393164623635616661663030316661756365742e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65746f6b656e6c61756e636865722e746573746e65757364742e746573746e6579323966323236363033633061663833663262663337666332356563633633633563303836386175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657365623233326366343161353264306635646235326634373831343533656331613861663061616175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465743933656431383731353031343861383732666661756365742e746573746e6577656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65757364742e746573746e6537316132326164643334386433353133643565373637386265616330656465366665626263386175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657832333131666230636261326664373165386467656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65757364742e746573746e61306164386238656561653230353565613834616e7469736f6369616c617065636c2e746573746e6572756c6c69736862756c6c732e746573746e65736861696e6c696e6b746f6b656e2e746573746e65756c63616663617274656c67656e312e746573746e657661756365742e746573746e657c7578746f6b656e2e746573746e67656e657269632e746573746e657f6f64666f7274756e6566656c692e746573746e686170692e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6d6172612e746573746e657d616a746f6b656e2e746573747262726f776e2e746573746e65e656172667574757265636c6173732e746573746e657d6565726b61746b696e672e746573746e6574696e6b6572756e696f6e2e746573746e657f6e6e66742e7465737b6f2e746573746e657068696c696d2e746573746e656745f7374616b696e672e746573746e6f696e66696e616e63652e746573746e6570617261732e746573746e657746e6572746f6b656e2e746573746e56d62726f636b2e746573746e657978656c746f6b656e2e746573746e6265616c62697264732e746573746e65736563726574736b656c6c696573732e746573746e65746865646f6e732e746573746e657756e6465616461726d792e7465737456e69737761702e746573746e6577364742e746573746e655656536396561316361623437393661666536623464633031643134373738366661383439616175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c6f636b65645f746f6b656e2e746573746e657f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465736231623135306261613262633864643031346175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c6f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746573746e65757364745f746f6b656e2e746573746e657864633136633935376438393962633436636a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e6265643539303934303063646262336338323265373739636330656536356530333630386139346175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c6f636b65645f746f6b656e2e746573746e657e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465753937623339636130616535396163386536376a756d705f746f6b656e2e746573746e657c6f636b65645f746f6b656e2e746573746e65763326330333963326164353834666264303831656363336630633436343735633331346130306175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e7465766434663865646232376530313135623433356a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e74657374662e646c6d696e742e746573746e696e66692e746573746e3133376435336266613230626236336561376467656e657269632e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e66745f7374616b696e672e746573746e65706172746e6572746f6b656e2e746573746e657265616c62697264732e746573746e6578666261613962636336643639363733393335303566613337383030333061383335613733326a756d705f746f6b656e2e746573746e656393536636163663466363765623965343931356436343864303733616663643530373633306175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c61756e63687061642e746573746e657f636b65645f746f6b656e2e746573746e6e6674312e746573746e65722e746573746e65732e746573746e655f7374616b696e672e74657374f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e74657377372d6465762d656c656374726f6e2d636f6e74726163742e75747361766a6e2e746573746e6561363034636165386538353439663634623732376239383936396565653139313634386566646175726f72615f746f6b656e2e746573746e657a756d705f746f6b656e2e746573746e657c6f636b65645f746f6b656e2e746573746e657f63746f7075735f746f6b656e2e746573746e65736b79776172645f746f6b656e2e746572363538");
    let x_nibbles: Vec<_> = x.chars().map(|c| char::to_digit(c, 16).unwrap() as u8).collect();
    let shard_uid = runtime.shard_id_to_uid(0, &epoch_id)?;
    let state_root = chain_store.get_chunk_extra(&block_hash, &shard_uid)?.state_root().clone();
    let trie = runtime.get_trie_for_shard(shard_id, &block_hash, state_root, false)?;
    let mut trie_iter = trie.iter()?;
    let path_begin_encoded = NibbleSlice::encode_nibbles(&x_nibbles, false);
    trie_iter.seek_nibble_slice(NibbleSlice::from_encoded(&path_begin_encoded).0, false)?;
    trie_iter.for_each(|item| {
        let item = item.unwrap();
        let sr = StateRecord::from_raw_key_value(item.0, item.1);
        debug!(target: "store", %sr);
    });
    panic!("Test finished");

    for shard_id in 0..num_shards {
        info!(target: "chain", %shard_id, "Start flat state shard migration");
        let shard_uid = runtime.shard_id_to_uid(shard_id, &epoch_id)?;
        let state_root = chain_store.get_chunk_extra(&block_hash, &shard_uid)?.state_root().clone();
        let trie = runtime.get_trie_for_shard(shard_id, &block_hash, state_root, false)?;

        let sub_trie_size = 1_000_000;
        let max_threads = 128;
        let thread_slots = Arc::new(std::sync::atomic::AtomicU32::new(max_threads));

        let mut state_iter = trie.iter()?;

        let mut handles = vec![];
        for sub_trie in state_iter.heavy_sub_tries(sub_trie_size)? {
            let TrieIterator { trie, trail, key_nibbles, visited_nodes } = sub_trie?;
            let storage = trie
                .storage
                .as_caching_storage()
                .expect("preload called without caching storage")
                .clone();
            let root = trie.get_root().clone();
            loop {
                if thread_slots.load(std::sync::atomic::Ordering::Relaxed) > 0 {
                    // guaranteed to not wrap because only the main thread subtracts
                    thread_slots.fetch_sub(1, std::sync::atomic::Ordering::Relaxed);
                    break;
                } else {
                    // TODO: consider using conditional variable
                    std::thread::sleep(std::time::Duration::from_micros(10));
                }
            }
            let inner_thread_slots = thread_slots.clone();
            let inner_store = store.clone();
            let handle = std::thread::spawn(move || {
                let hex_prefix: String = key_nibbles
                    .iter()
                    .map(|&n| char::from_digit(n as u32, 16).expect("nibble should be <16"))
                    .collect();
                debug!(target: "store", "Preload subtrie at {hex_prefix}");
                let trie = Trie::new(Box::new(storage), root, None);
                let inner_iter = TrieIterator { trie: &trie, trail, key_nibbles, visited_nodes };
                let mut store_update = BatchedStoreUpdate::new(&inner_store, 1_000);
                let n = inner_iter
                    .map(|item| {
                        let item = item.unwrap();
                        let value_ref = ValueRef::new(&item.1);
                        store_update
                            .set_ser(DBCol::FlatState, &item.0, &value_ref)
                            .expect("Failed to put value in FlatState");
                    })
                    .count();
                store_update.finish().unwrap();
                debug!(target: "store", "Preload subtrie at {hex_prefix} done, loaded {n:<8} state items");
                inner_thread_slots.fetch_add(1, std::sync::atomic::Ordering::Relaxed);
                n
            });
            handles.push(handle);
        }

        let mut n = 0;
        for handle in handles {
            n += handle.join().expect("thread failed");
        }
        info!(target: "store", "Wrote {n} state items");
    }

    Ok(())
}

/// In test runs reads and writes here used 442 TGas, but in test on live net migration take
/// between 4 and 4.5s. We do not want to process any receipts in this block
const GAS_USED_FOR_STORAGE_USAGE_DELTA_MIGRATION: Gas = 1_000_000_000_000_000;

pub fn load_migration_data(chain_id: &str) -> MigrationData {
    let is_mainnet = chain_id == "mainnet";
    MigrationData {
        storage_usage_delta: if is_mainnet {
            near_mainnet_res::mainnet_storage_usage_delta()
        } else {
            Vec::new()
        },
        storage_usage_fix_gas: if is_mainnet {
            GAS_USED_FOR_STORAGE_USAGE_DELTA_MIGRATION
        } else {
            0
        },
        restored_receipts: if is_mainnet {
            near_mainnet_res::mainnet_restored_receipts()
        } else {
            ReceiptResult::default()
        },
    }
}

pub(super) struct Migrator<'a> {
    config: &'a crate::config::NearConfig,
}

impl<'a> Migrator<'a> {
    pub fn new(config: &'a crate::config::NearConfig) -> Self {
        Self { config }
    }
}

/// Asserts that node’s configuration does not use deprecated snapshot config
/// options.
///
/// The `use_db_migration_snapshot` and `db_migration_snapshot_path`
/// configuration options have been deprecated in favour of
/// `store.migration_snapshot`.
///
/// This function panics if the old options are set and shows instruction how to
/// migrate to the new options.
///
/// This is a hack which stops `StoreOpener` before it attempts migration.
/// Ideally we would propagate errors nicely but that would complicate the API
/// a wee bit so instead we’re panicking.  This shouldn’t be a big deal since
/// the deprecated options are going away ‘soon’.
fn assert_no_deprecated_config(config: &crate::config::NearConfig) {
    use near_store::config::MigrationSnapshot;

    let example = match (
        config.config.use_db_migration_snapshot,
        config.config.db_migration_snapshot_path.as_ref(),
    ) {
        (None, None) => return,
        (Some(false), _) => MigrationSnapshot::Enabled(false),
        (_, None) => MigrationSnapshot::Enabled(true),
        (_, Some(path)) => MigrationSnapshot::Path(path.join("migration-snapshot")),
    };
    panic!(
        "‘use_db_migration_snapshot’ and ‘db_migration_snapshot_path’ options \
         are deprecated.\nSet ‘store.migration_snapshot’ to instead, e.g.:\n{}",
        example.format_example()
    )
}

impl<'a> near_store::StoreMigrator for Migrator<'a> {
    fn check_support(&self, version: DbVersion) -> Result<(), &'static str> {
        assert_no_deprecated_config(self.config);
        // TODO(mina86): Once open ranges in match are stabilised, get rid of
        // this constant and change the match to be 27..DB_VERSION.
        const LAST_SUPPORTED: DbVersion = DB_VERSION - 1;
        match version {
            0..=26 => Err("1.26"),
            27..=LAST_SUPPORTED => Ok(()),
            _ => unreachable!(),
        }
    }

    fn migrate(&self, storage: &NodeStorage, version: DbVersion) -> anyhow::Result<()> {
        match version {
            0..=26 => unreachable!(),
            27 => {
                // version 27 => 28: add DBCol::StateChangesForSplitStates
                //
                // Does not need to do anything since open db with option
                // `create_missing_column_families`.  Nevertheless need to bump
                // db version, because db_version 27 binary can't open
                // db_version 28 db.  Combine it with migration from 28 to 29;
                // don’t do anything here.
                Ok(())
            }
            28 => near_store::migrations::migrate_28_to_29(storage),
            29 => near_store::migrations::migrate_29_to_30(storage),
            30 => migrate_30_to_31(storage, &self.config),
            31 => near_store::migrations::migrate_31_to_32(storage),
            32 => near_store::migrations::migrate_32_to_33(storage),
            33 => {
                near_store::migrations::migrate_33_to_34(storage, self.config.client_config.archive)
            }
            #[cfg(feature = "protocol_feature_flat_state")]
            34 => migrate_34_to_35(storage, &self.config),
            DB_VERSION.. => unreachable!(),
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use near_mainnet_res::mainnet_restored_receipts;
    use near_mainnet_res::mainnet_storage_usage_delta;
    use near_primitives::hash::hash;

    #[test]
    fn test_migration_data() {
        assert_eq!(
            hash(serde_json::to_string(&mainnet_storage_usage_delta()).unwrap().as_bytes())
                .to_string(),
            "2fEgaLFBBJZqgLQEvHPsck4NS3sFzsgyKaMDqTw5HVvQ"
        );
        let mainnet_migration_data = load_migration_data("mainnet");
        assert_eq!(mainnet_migration_data.storage_usage_delta.len(), 3112);
        let testnet_migration_data = load_migration_data("testnet");
        assert_eq!(testnet_migration_data.storage_usage_delta.len(), 0);
    }

    #[test]
    fn test_restored_receipts_data() {
        assert_eq!(
            hash(serde_json::to_string(&mainnet_restored_receipts()).unwrap().as_bytes())
                .to_string(),
            "48ZMJukN7RzvyJSW9MJ5XmyQkQFfjy2ZxPRaDMMHqUcT"
        );
        let mainnet_migration_data = load_migration_data("mainnet");
        assert_eq!(mainnet_migration_data.restored_receipts.get(&0u64).unwrap().len(), 383);
        let testnet_migration_data = load_migration_data("testnet");
        assert!(testnet_migration_data.restored_receipts.is_empty());
    }
}
