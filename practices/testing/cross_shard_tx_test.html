<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>cross_shard_tx Test - Guide to Nearcore Development</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture</li><li class="chapter-item expanded "><a href="../../architecture/index.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../architecture/trie.html"><strong aria-hidden="true">2.</strong> Trie</a></li><li class="chapter-item expanded "><a href="../../architecture/network.html"><strong aria-hidden="true">3.</strong> Network</a></li><li class="chapter-item expanded affix "><li class="part-title">Practices</li><li class="chapter-item expanded "><a href="../../practices/index.html"><strong aria-hidden="true">4.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../practices/style.html"><strong aria-hidden="true">5.</strong> Code Style</a></li><li class="chapter-item expanded "><a href="../../practices/testing/index.html"><strong aria-hidden="true">6.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../practices/testing/python_tests.html"><strong aria-hidden="true">6.1.</strong> Python Tests</a></li><li class="chapter-item expanded "><a href="../../practices/testing/cross_shard_tx_test.html" class="active"><strong aria-hidden="true">6.2.</strong> cross_shard_tx Test</a></li></ol></li><li class="chapter-item expanded "><a href="../../practices/protocol_upgrade.html"><strong aria-hidden="true">7.</strong> Protocol Upgrade</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="../../misc/index.html"><strong aria-hidden="true">8.</strong> Misc</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Guide to Nearcore Development</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/near/nearcore/tree/master/docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/near/nearcore/edit/master/docs/src/practices/testing/cross_shard_tx_test.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><code>cross_shard_tx</code> test is a test that tests many complex features of the server
and uses <code>KeyValueRuntime</code>.</p>
<p>We generally do not write many new tests using <code>KeyValueRuntime</code> given the
limitations of it, and generally one wouldn't interact with it except to debug
issues with <code>cross_shard_tx</code>, so this section provides basic overview of both
the particular test and the infrastructure it uses.</p>
<h2 id="keyvalueruntime"><a class="header" href="#keyvalueruntime">KeyValueRuntime</a></h2>
<p>KeyValueRuntime is written to be able to test chain without creating the actual
Runtime. It thus doesn't use the actual storage, and doesn't use the actual
epoch manager. The storage it uses is a simple key value store, and for the
epoch manager, it is parametrized with a vector of vectors of validators
<code>validators: Vec&lt;Vec&lt;ValidatorStake&gt;&gt;</code>, where for epoch <code>i</code> the validator set
consists of <code>validators[i % validators.len()]</code>.</p>
<h2 id="setup_mock_all_validators"><a class="header" href="#setup_mock_all_validators">setup_mock_all_validators</a></h2>
<p><code>setup_mock_all_validators</code> is given a <code>Vec&lt;Vec&lt;str&gt;&gt;</code> and a parallel set of key
pairs, and creates the <code>KeyValueRuntime</code>, <code>ClientActor</code> and <code>ViewClientActor</code>
per validator. It then establishes a fake network between them. The last
argument to <code>setup_mock_all_validators</code> is a handler that is called for each
messages that is passed between the validators, and returns a pair <code>(resonse, perform_default)</code>. If <code>perform_default</code> is <code>true</code>, the <code>response</code> is ignored,
and the default handler is executed (that will send message to the recipient(s),
compute the response from their standpoint, and send it back. If
<code>perform_default</code> is <code>false</code>, the default handler is not executed, in particular
the message is dropped and is not delivered to the recipients. The <code>response</code> is
then sent as a response to the original sender.</p>
<p><code>setup_mock_all_validators</code> receives a set of booleans and other parameters that
enable various test modes:</p>
<h3 id="validator_groups"><a class="header" href="#validator_groups">validator_groups</a></h3>
<p>This parameter splits the validators in each shard into that many groups, and
assigns a separate set of shards to each group. E.g. if there are 8 validators
in a particular epoch, and 4 shards, and 2 validator groups, 4 validators will
be assigned to two shards, and 4 remaining validators will be assigned to 2
remaining shards. With 8 validators, 4 shards and 4 validator groups each shard
will be assigned to two validators.</p>
<p>The number of shards is the number of validators in the epoch that has the
smallest number of validators.</p>
<h3 id="block_prod_time"><a class="header" href="#block_prod_time">block_prod_time</a></h3>
<p><code>min_block_production_time</code> will be set to this value,
<code>max_block_production_time</code> to this value times 3.</p>
<h3 id="drop_chunks"><a class="header" href="#drop_chunks">drop_chunks</a></h3>
<p>If set to true, some small percentage of chunk-related messages will be dropped</p>
<h3 id="tamper_with_fg"><a class="header" href="#tamper_with_fg">tamper_with_fg</a></h3>
<p>If set to false, all the approvals are delivered. Otherwise at some heights no
approvals will be delivered, at some heights only half, and at some heights all
will be delivered. It was designed to tamper with the finality gadget when we
had it, unclear if has much effect today. Must be disabled if doomslug is
enabled (see below), because doomslug will stall if approvals are not delivered.</p>
<h3 id="enable_doomslug"><a class="header" href="#enable_doomslug">enable_doomslug</a></h3>
<p>If false, blocks will be created when at least one approval is present, without
waiting for 2/3. This allows for more forkfulness. <code>cross_shard_tx</code> has modes
both with enabled doomslug (to test &quot;production&quot; setting) and with disabled
doomslug (to test higher forkfullness)</p>
<h2 id="cross_shard_tx"><a class="header" href="#cross_shard_tx">cross_shard_tx</a></h2>
<p>The basic flow of the test spins up validators, and starts sending to them
several (at most 64) cross-shard transactions. i-th transaction sends money from
validator i/8 to validator i%8. What makes the test good is that due to very low
block production time, it creates lots of forks, delaying both the transaction
acceptance, and the receipt delivery.</p>
<p>It submits txs one at a time, and waits for their completion before sending the
next. Whenever the transaction completed, it traces &quot;Finished iteration 1&quot; (with
the ordinal increasing). Given the test takes a while, checking how far below
the last some message is a good way to early tell that the test has stalled.
E.g. if the last message is not in the last 15% of the output, it is likely that
the test will not make further progress, depending on the mode (with validator
rotation some iterations are way longer than other).</p>
<p>The test has multiple modes:</p>
<ul>
<li>
<p><code>test_cross_shard_tx</code> -- doesn't drop chunks, disabled doomslug, no validator
rotation (each epoch has the same set of validators)</p>
</li>
<li>
<p><code>test_cross_shard_tx_doomslug</code> -- same as above, but doomslug is enabled</p>
</li>
<li>
<p><code>test_cross_shard_tx_drop_chunks</code> -- same as the first one but the chunks are
sometimes dropped</p>
</li>
<li>
<p><code>test_cross_shard_tx_with_validator_rotation_{1, 2}</code> -- same as the first one,
but with validator rotation. The two versions of the test have slightly
different block production times, and different number of iterations we expect
to finish in the allocated time. (the one with lower block production time is
expected to finish fewer because it has higher forkfulness).</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../practices/testing/python_tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../practices/protocol_upgrade.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../practices/testing/python_tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../practices/protocol_upgrade.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
